<!DOCTYPE html>
<html>
<head>
    <title>Flask Index</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='bootstrap.min.css') }}">
    <style>
        body {
            background-color: #f8f9fa;
            background-image: url("/static/Background.jpg");
            background-size: cover;
            background-repeat: no-repeat;
            background-position: center;
        }

        .container {
            max-width: 500px;
            margin-top: 100px;
            
            text-align: center;
        }

        h1 {
            font-size: 36px;
            color: #333;
        }

        .lead {
            font-size: 24px;
            color: #666;
            margin-bottom: 40px;
        }
        
        .btn-secondary{
            margin-top: 15px;
        }

        .custom-file-label::after {
            content: attr(data-content);
        }
        
        .custom-file-label {
            text-align: left;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1 id="title-en">Image Uploader</h1>
        <h1 id="title-es" style="display: none;">Subida de Imagen</h1>
        <form action="/upload" method="POST" enctype="multipart/form-data" id="upload-form">
            <div class="mb-3">
                <div class="custom-file">
                    <input type="file" class="custom-file-input" id="image" name="image" accept="image/*" onchange="loadAndDrawImage(this)">
                    <label class="custom-file-label" id="input-btn-en" data-content="Select Image">Choose file</label>
                    <label class="custom-file-label" id="input-btn-es" style="display: none;" data-content="Seleccionar Imagen">Seleccionar archivo</label>
                </div>
            </div>
            <button type="submit" class="btn btn-primary" id="upload-btn-en">Upload</button>
            <button type="submit" class="btn btn-primary" id="upload-btn-es" style="display: none;">Subir</button>
            <input id="bbox-input" type="hidden" name="bbox" value="">
        </form>
        <a href="/" id="home-btn-en" class="btn btn-secondary">Go to Home</a>
        <a href="/" id="home-btn-es" class="btn btn-secondary" style="display: none;">Ir a Inicio</a>
        
        <div class="mt-3">
            <button onclick="changeLanguage('en')" class="btn btn-secondary">English</button>
            <button onclick="changeLanguage('es')" class="btn btn-secondary">Espa√±ol</button>
        </div>
    </div>
    <div class="container">
        <h2>Draw a bounding box:</h2>
        <canvas id="canvas" style="border:1px solid #d3d3d3;">
        Your browser does not support the HTML5 canvas tag.</canvas>
    </div>
    
    <script>
        var canvas = document.getElementById('canvas');
        var ctx = canvas.getContext('2d');
        var rect = {};
        var drag = false;
        var img = new Image();
        
        var scale = { // stores scale ratio and shift positions
            ratio: 1,
            shiftX: 0,
            shiftY: 0
        };
        
        // Function to handle the image file selection and load the image onto the canvas
        function loadAndDrawImage(input) {
            var file = input.files[0];
            var labelEn = document.getElementById('input-btn-en');
            var labelEs = document.getElementById('input-btn-es');
        
            if (file) {
                labelEn.innerText = file.name;
                labelEs.innerText = file.name;
                img.onload = function() {
                    // scaling the image
                    var hRatio = canvas.width / img.width;
                    var vRatio = canvas.height / img.height;
                    var ratio  = Math.min(hRatio, vRatio);
                    var centerShift_x = (canvas.width - img.width*ratio) / 2;
                    var centerShift_y = (canvas.height - img.height*ratio) / 2;  
                    ctx.clearRect(0,0,canvas.width, canvas.height);
                    ctx.drawImage(img, 0,0, img.width, img.height, centerShift_x,centerShift_y, img.width*ratio, img.height*ratio);
                    scale.ratio = ratio;
                    scale.shiftX = centerShift_x;
                    scale.shiftY = centerShift_y;
                };
                img.src = URL.createObjectURL(file);
            } else {
                labelEn.innerText = labelEn.getAttribute('data-content');
                labelEs.innerText = labelEs.getAttribute('data-content');
            }
        }
        
        function init() {
            canvas.addEventListener('mousedown', mouseDown, false);
            canvas.addEventListener('mouseup', mouseUp, false);
            canvas.addEventListener('mousemove', mouseMove, false);
        }
        
        function mouseDown(e) {
            rect.startX = e.pageX - this.offsetLeft;
            rect.startY = e.pageY - this.offsetTop;
            drag = true;
        }
        
        function mouseUp() { drag = false; }
        
        function mouseMove(e) {
            if (drag) {
                rect.w = (e.pageX - this.offsetLeft) - rect.startX;
                rect.h = (e.pageY - this.offsetTop) - rect.startY ;
                ctx.clearRect(0,0,canvas.width,canvas.height);
                ctx.drawImage(img, 0, 0, img.width, img.height, scale.shiftX, scale.shiftY, img.width*scale.ratio, img.height*scale.ratio); // draw the image again
                draw();
            }
        }
        
        function draw() {
            ctx.strokeRect(rect.startX, rect.startY, rect.w, rect.h);
        
            var startX = (rect.startX - scale.shiftX) / scale.ratio;
            var startY = (rect.startY - scale.shiftY) / scale.ratio;
            var width = rect.w / scale.ratio;
            var height = rect.h / scale.ratio;
        
            var bbox_values = [
                (startX + width / 2) / img.width, // Normalize x_center
                (startY + height / 2) / img.height, // Normalize y_center
                width / img.width, // Normalize width
                height / img.height // Normalize height
            ];
        
            document.getElementById('bbox-input').value = JSON.stringify(bbox_values);
            console.log(JSON.stringify(bbox_values)); // Add this line for debugging
        }
        
        
        // initialize it.
        init();
        </script>
        
    
      
    <script>
        function changeLanguage(language) {
            var titleEn = document.getElementById('title-en');
            var titleEs = document.getElementById('title-es');
            var inputBtnEn = document.getElementById('input-btn-en');
            var inputBtnEs = document.getElementById('input-btn-es');
            var uploadBtnEn = document.getElementById('upload-btn-en');
            var uploadBtnEs = document.getElementById('upload-btn-es');
            var homeBtnEn = document.getElementById('home-btn-en');
            var homeBtnEs = document.getElementById('home-btn-es');
            
            if (language === 'en') {
                titleEn.style.display = 'block';
                titleEs.style.display = 'none';
                inputBtnEn.style.display = 'block';
                inputBtnEs.style.display = 'none';
                uploadBtnEn.style.display = 'inline-block';
                uploadBtnEs.style.display = 'none';
                homeBtnEn.style.display = 'inline-block';
                homeBtnEs.style.display = 'none';
            } else if (language === 'es') {
                titleEn.style.display = 'none';
                titleEs.style.display = 'block';
                inputBtnEn.style.display = 'none';
                inputBtnEs.style.display = 'block';
                uploadBtnEn.style.display = 'none';
                uploadBtnEs.style.display = 'inline-block';
                homeBtnEn.style.display = 'none';
                homeBtnEs.style.display = 'inline-block';
            }
        }
        
        function updateLabel(input) {
            var file = input.files[0];
            var labelEn = document.getElementById('input-btn-en');
            var labelEs = document.getElementById('input-btn-es');
            
            if (file) {
                labelEn.innerText = file.name;
                labelEs.innerText = file.name;
            } else {
                labelEn.innerText = labelEn.getAttribute('data-content');
                labelEs.innerText = labelEs.getAttribute('data-content');
            }
        }
    </script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
